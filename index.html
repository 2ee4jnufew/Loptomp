<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loptomp</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/markdown-it/13.0.1/markdown-it.min.js"
        integrity="sha512-SYfDUYPg5xspsG6OOpXU366G8SZsdHOhqk/icdrYJ2E/WKZxPxze7d2HD3AyXpT7U22PZ5y74xRpqZ6A2bJ+kQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Montserrat:ital,wght@0,100..900;1,100..900&family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
        rel="stylesheet">

    <style>
        html {
            font-family: 'Montserrat', sans-serif;
            color: rgb(242, 170, 197);
            background-color: rgb(0, 0, 0);
            font-size: 15px;
        }

        .content {
            max-width: 1000px;
            width: calc(100% - 20px);
            margin: 20px;
            margin-left: auto;
            margin-right: auto;
        }

        a {
            color: rgb(242, 170, 197);
        }

        #article-list {
            display: flex;
            flex-direction: column;
        }

        #article-list>a {
            margin-left: 0.5em;
        }

        #article-content * {
            max-width: 100%;
        }

        #title-header {
            font-family: 'Nunito', sans-serif;
            font-weight: 600;
            text-transform: uppercase;
        }
    </style>
</head>

<body>
    <div class="content">
        <div id="article" style="display: none">
            <div style="display: flex; flex-direction: row;">
                <a href="/Loptomp/">На Главную</a>
            </div>
            <h1 id="title-header" style="margin-bottom: 0; margin-top: 0.5em">Загрузка...</h1>
            <span id="date-display" style="opacity: 0.5; font-size: 0.9em">Дата отсутсвует</span>
            <div id="article-content"></div>
        </div>

        <div id="homepage" style="display: none">
            <h1>Проекты</h1>
            <p>
                Lorem ipsum dolor sit amet consectetur adipisicing elit. Iste omnis hic consequatur magnam, culpa dolor
                nisi adipisci id placeat repellendus.
            </p>
            <div id="article-list">
                Загрузка проектов...
            </div>
        </div>
    </div>

    <script>
        const articles = [];

        if (window.location.search) {
            const params = new URLSearchParams(window.location.search);
            if (params.has('a'))
                loadArticle(params.get('a').replaceAll('-', ' '));
            else
                loadArticleList();
        } else {
            loadArticleList();
        }

        function loadArticle(path) {
            document.getElementById('article').style.display = null;
            document.getElementById('homepage').style.display = 'none';

            const articlesEndpoint = 'https://api.github.com/repos/2ee4jnufew/Loptomp/contents/articles/' + path;
            window.fetch(articlesEndpoint).then(d => d.json()).then(
                data => {
                    const container = document.getElementById('article-content')
                    container.innerHTML = markdownit().render(atob(data.content));
                    document.getElementById('title-header').innerText = data.name.split('.')[0];

                    const article = {
                        localPath: 'articles/' + data.name
                    }
                    getDate(article, date => {
                        const elem = document.getElementById('date-display');
                        elem.innerText = date.toLocaleDateString();
                        elem.title = date.toString();
                    });
                }
            );
        }

        async function loadArticleList() {
            const articlesEndpoint = 'https://api.github.com/repos/2ee4jnufew/Loptomp/contents/articles';
            const data = await (await window.fetch(articlesEndpoint)).json();

            for (const entry of data) {
                const article = {
                    id: entry.name.replaceAll(' ', '-'),
                    name: entry.name.split('.')[0],
                    fetch: entry.download_url,
                    localPath: entry.path
                };

                await getDateAsync(article);

                articles.push(article)
                articles.sort((a, b) => b.date.getTime() - a.date.getTime());
                generateListElement();
            }
        }

        async function getDateAsync(article) {
            const endpoint = `https://api.github.com/repos/2ee4jnufew/Loptomp/commits?per_page=1&path=${article.localPath}`;
            const response = await window.fetch(endpoint);
            const data = await response.json();

            if (data.length > 0) {
                article.date = new Date(data[0].commit.committer.date);
            }
        }

        function getDate(article, action) {
            const endpoint = `https://api.github.com/repos/2ee4jnufew/Loptomp/commits?per_page=1&path=${article.localPath}`;
            window.fetch(endpoint).then(d => d.json()).then(
                data => {
                    if (data.length > 0) {
                        article.date = new Date(data[0].commit.committer.date);
                        if (action)
                            action(article.date);
                    }
                }
            );
        }

        function generateListElement() {
            document.getElementById('homepage').style.display = null;
            document.getElementById('article').style.display = 'none';

            const container = document.getElementById('article-list');
            container.innerHTML = '<b>Articles</b>';

            for (const article of articles) {
                const link = document.createElement('a');
                link.href = '/Loptomp?a=' + article.id;
                link.innerText = article.name;
                container.append(link);
            }
        } const md = require('markdown-it')({
            html: true, // Разрешить HTML-теги
            breaks: true, // Переносы строк
            langPrefix: 'language-', // Префикс для блоков кода
            // Убедитесь, что нет фильтрации символов
        });
    </script>
</body>

</html>